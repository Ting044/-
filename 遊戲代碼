<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¸é†«å¤§å­¸ç‰²æœ€å¾Œçš„æ™æ‰ - UIç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: manipulation;
            background-color: #f1f5f9; /* slate-100 */
            background-image: url('https://www.transparenttextures.com/patterns/subtle-white-feathers.png');
        }
        .game-title {
            text-shadow: 2px 2px 0px #d1d5db, 4px 4px 0px rgba(0,0,0,0.1);
        }
        .status-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        .action-button {
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .action-button:hover {
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .action-button:active {
            transform: translateY(-1px) scale(1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(20px) scale(0.95); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(107, 114, 128, 0.75); /* gray-500 */
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .modal-content.closing {
            animation: fadeOut 0.3s ease-in forwards;
        }

        @keyframes tada {
            0% {transform: scale(1);} 10%, 20% {transform: scale(0.9) rotate(-5deg);} 30%, 50%, 70%, 90% {transform: scale(1.2) rotate(5deg);} 40%, 60%, 80% {transform: scale(1.2) rotate(-5deg);} 100% {transform: scale(1) rotate(0);}
        }
        .tada-animation {
            animation: tada 1s ease-in-out;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 sm:p-4 text-gray-800">

    <div id="game-container" class="w-full max-w-4xl mx-auto bg-white/80 backdrop-blur-lg border border-gray-200 rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8 space-y-4 md:space-y-6">
        
        <header class="text-center">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-black game-title text-indigo-600">ç¸é†«å¤§å­¸ç‰²æœ€å¾Œçš„æ™æ‰</h1>
            <p id="day-display" class="text-base sm:text-lg text-gray-600 mt-2">å€’æ•¸ç¬¬ 14 å¤© (æ˜ŸæœŸä¸€)</p>
        </header>

        <!-- *** å·²ä¿®æ”¹ ***: åŠ å…¥ md: tiá»n tá»‘ Ä‘á»ƒå¯¦ç¾éŸ¿æ‡‰å¼ä½ˆå±€ -->
        <main class="grid grid-cols-1 md:grid-cols-5 gap-4 md:gap-6">
            
            <div class="md:col-span-2 flex flex-col items-center justify-center bg-slate-200/60 p-4 rounded-lg space-y-4">
                <div>
                    <span class="block text-sm font-bold text-emerald-600 mb-1">ç²¾ç¥å€¼</span>
                    <div class="status-bar w-full max-w-xs mx-auto bg-gray-300 rounded-full h-4">
                        <div id="stamina-bar" class="status-bar-fill bg-emerald-500 h-4 rounded-full" style="width: 100%;"></div>
                    </div>
                     <p id="stamina-text" class="text-center text-xs mt-1 text-gray-500">100 / 120</p>
                </div>
                <div>
                    <span class="block text-sm font-bold text-sky-600 mb-1">é‡‘éŒ¢</span>
                     <div class="status-bar w-full max-w-xs mx-auto bg-gray-300 rounded-full h-4">
                        <div id="money-bar" class="status-bar-fill bg-sky-500 h-4 rounded-full" style="width: 75%;"></div>
                    </div>
                    <p id="money-text" class="text-center text-xs mt-1 text-gray-500">$1500</p>
                </div>
            </div>

            <div class="md:col-span-3 bg-slate-200/60 p-4 rounded-lg">
                <h2 class="text-lg font-bold mb-2 border-b border-gray-300 pb-2">å­¸æ¥­é€²åº¦</h2>
                <div id="grades-panel" class="space-y-2 text-sm">
                </div>
            </div>

        </main>

        <footer id="action-panel" class="pt-4 border-t border-gray-300">
        </footer>

    </div>

    <div id="modal-template" class="modal-overlay hidden">
        <div class="modal-content w-11/12 max-w-lg bg-white border border-gray-300 rounded-2xl shadow-lg p-6 sm:p-8 space-y-4 text-center">
            <h3 id="modal-title" class="text-xl sm:text-2xl font-bold text-indigo-600"></h3>
            <p id="modal-text" class="text-gray-700 text-sm sm:text-base"></p>
            <div id="modal-stats" class="text-sm sm:text-base"></div>
            <div id="modal-choices" class="grid grid-cols-1 gap-3 sm:gap-4 pt-4"></div>
        </div>
    </div>


    <script>
        // ==================================
        // 1. éŠæˆ²ç‹€æ…‹åˆå§‹åŒ–
        // ==================================
        let gameState = {};

        function initializeGameState() {
            const initialGrades = {
                'ä¿è‚²é†«å­¸æ¦‚è«–': 42,
                'æœ‰æ©ŸåŒ–å­¸': 30,
                'ç´°èƒç”Ÿç‰©å­¸': 35,
                'ç¸é†«ç´°èŒå­¸': 33,
                'ç¸é†«è§£å‰–å­¸(2)': 28,
            };

            gameState = {
                day: 1,
                stamina: 100,
                maxStamina: 120,
                money: 1500,
                grades: { ...initialGrades },
                kp: Object.keys(initialGrades).reduce((acc, key) => ({ ...acc, [key]: 0 }), {}),
                history: [],
                isGameOver: false,
                isWaitingForEventChoice: false,
            };
        }

        // ==================================
        // 2. DOM å…ƒç´ ç²å–
        // ==================================
        const dayDisplay = document.getElementById('day-display');
        const staminaDisplay = document.getElementById('stamina-bar');
        const staminaText = document.getElementById('stamina-text');
        const moneyDisplay = document.getElementById('money-bar');
        const moneyText = document.getElementById('money-text');
        const gradesPanel = document.getElementById('grades-panel');
        const actionPanel = document.getElementById('action-panel');
        const modal = document.getElementById('modal-template');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const modalStats = document.getElementById('modal-stats');
        const modalChoices = document.getElementById('modal-choices');


        // ==================================
        // 3. ç•«é¢æ›´æ–°å‡½å¼
        // ==================================
        function updateDisplay() {
            if (gameState.isGameOver) return;
            
            const dayName = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'][(gameState.day - 1)];
            dayDisplay.textContent = `å€’æ•¸ç¬¬ ${15 - gameState.day} å¤© (æ˜ŸæœŸ${dayName})`;
            
            const staminaPercentage = Math.max(0, (gameState.stamina / gameState.maxStamina) * 100);
            staminaDisplay.style.width = `${staminaPercentage}%`;
            staminaText.textContent = `${gameState.stamina} / ${gameState.maxStamina}`;
            staminaDisplay.classList.toggle('bg-red-500', staminaPercentage < 30);
            staminaDisplay.classList.toggle('bg-emerald-500', staminaPercentage >= 30);
            
            const moneyPercentage = Math.min(100, (gameState.money / 5000) * 100);
            moneyDisplay.style.width = `${moneyPercentage}%`;
            moneyText.textContent = `$${gameState.money}`;
            
            gradesPanel.innerHTML = '';
            for (const subject in gameState.grades) {
                const grade = gameState.grades[subject];
                const kp = gameState.kp[subject];
                const estimatedGrade = Math.min(100, grade + Math.floor(kp / 1.0)); 
                
                const gradeElement = document.createElement('div');
                gradeElement.className = `p-2 rounded ${estimatedGrade < 60 ? 'bg-red-200' : 'bg-emerald-200'}`;
                gradeElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-gray-700">${subject}</span>
                        <span class="font-bold ${estimatedGrade < 60 ? 'text-red-600' : 'text-emerald-700'}">${estimatedGrade}åˆ†</span>
                    </div>
                    <div class="text-xs text-gray-500">çŸ¥è­˜é»(KP): ${kp}</div>
                `;
                gradesPanel.appendChild(gradeElement);
            }
        }

        // ==================================
        // 4. éŠæˆ²é‚è¼¯æ ¸å¿ƒ (å½ˆçª—ç³»çµ±æ•´åˆ)
        // ==================================
        function showModal({ title, text, stats, choices }) {
            modalTitle.textContent = title;
            modalText.innerHTML = text; 

            modalStats.innerHTML = '';
            if (stats) {
                let parts = [];
                if (stats.stamina) parts.push(`<span class="${stats.stamina > 0 ? 'text-emerald-600' : 'text-red-600'}">ç²¾ç¥å€¼ ${stats.stamina > 0 ? '+' : ''}${stats.stamina}</span>`);
                if (stats.money) parts.push(`<span class="${stats.money > 0 ? 'text-sky-600' : 'text-red-600'}">é‡‘éŒ¢ ${stats.money > 0 ? '+' : ''}${stats.money}</span>`);
                if (stats.kp) {
                    for(const sub in stats.kp) parts.push(`<span class="text-amber-600">${sub} KP ${stats.kp[sub] > 0 ? '+' : ''}${stats.kp[sub]}</span>`);
                }
                modalStats.innerHTML = parts.join(', ');
            }

            modalChoices.innerHTML = '';
            if (choices) {
                choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = `action-button p-3 rounded-lg text-white font-bold ${choice.style || 'bg-gray-500'}`;
                    button.textContent = choice.text;
                    button.onclick = () => {
                        modal.classList.add('closing');
                        setTimeout(() => {
                           modal.classList.add('hidden');
                           modal.classList.remove('closing');
                           choice.action();
                        }, 300);
                    };
                    modalChoices.appendChild(button);
                });
            }
            
            modal.classList.remove('hidden');
        }

        function processDay() {
            if (gameState.isGameOver) return;
            promptDailyAction();
        }
        
        function promptDailyAction() {
            // *** å·²ä¿®æ”¹ ***: æŒ‰éˆ•ä½ˆå±€éŸ¿æ‡‰å¼èª¿æ•´
            actionPanel.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 md:gap-4">
                    <button data-action="study" class="action-button bg-emerald-500 text-white p-3 md:p-4 rounded-lg font-bold">è®€æ›¸...å§ï¼Ÿ</button>
                    <button data-action="work" class="action-button bg-amber-500 text-white p-3 md:p-4 rounded-lg font-bold">æ‰“å·¥è³£è‚</button>
                    <button data-action="rest" class="action-button bg-sky-500 text-white p-3 md:p-4 rounded-lg font-bold">æˆ°ç•¥æ€§æ”¾æ£„</button>
                </div>
            `;
        }
        
        function handleAction(action) {
            if (gameState.isWaitingForEventChoice) return;
            switch(action) {
                case 'study': promptStudySubject(); break;
                case 'work': performWork(); break;
                case 'rest': performRest(); break;
                default:
                    if (action.startsWith('study-')) {
                        const subject = action.replace('study-', '');
                        performStudy(subject);
                    }
            }
        }
        
        function promptStudySubject() {
            let choices = [];
            for (const subject in gameState.grades) {
                choices.push({
                    text: subject,
                    style: 'bg-emerald-600',
                    action: () => performStudy(subject)
                });
            }
            showModal({
                title: 'è¦æ“ å“ªä¸€ç§‘ï¼Ÿ',
                text: 'æ™‚é–“æ˜¯OOï¼Œæ“ ä¸€æ“ å°±æœ‰äº†ã€‚',
                choices: choices
            });
        }
        
        function performStudy(subject) {
            let messages = [];
            let changes = { stamina: -20, kp: { [subject]: 30 } }; 
            
            switch(subject) {
                case 'ç¸é†«è§£å‰–å­¸(2)':
                    messages = ["ä½ èµ°é€² VMII111ï¼Œç¦é¦¬æ—çš„æ°£å‘³è®“ä½ ç¬é–“é†’è…¦...", "ä½ ç¿»é–‹Netterè§£å‰–åœ–è­œï¼Œé‚£äº›è‚Œè‚‰çº–ç¶­åœ–åœ¨ä½ çœ¼è£¡è®Šæˆäº†ä¸€å¡Šå¡Šé®®ç¾çš„ç‰›è‚‰...", "ä½ è©¦åœ–è¨˜ä½çŠ¬çš„è…•éª¨æœ‰å¹¾å¡Šï¼Œçµæœæ»¿è…¦å­éƒ½æ˜¯ç‰ å€‘å¯æ„›çš„è‚‰çƒ..."];
                    changes = { stamina: -25, kp: { [subject]: 35 } };
                    break;
                case 'æœ‰æ©ŸåŒ–å­¸':
                    messages = ["ä½ ç›¯è‘—æ²ˆåœ‹å±è€å¸«ç•«çš„è‹¯ç’°ï¼Œç›¯åˆ°æ„Ÿè¦ºé‚£äº›å…­è§’å½¢é–‹å§‹åœ¨ä½ çœ¼å‰è·³èˆ...", "SN1ã€SN2ã€E1ã€E2...é€™äº›é¬¼æ±è¥¿åœ¨ä½ è…¦ä¸­æ‰“æˆä¸€åœ˜...", "ä½ ç•«äº†ä¸€å€‹å®Œç¾çš„ç’°å·±çƒ·èˆ¹å¼æ§‹è±¡ï¼Œä¸¦ç‚ºè‡ªå·±å°å°çš„è—è¡“æˆå°±æ„Ÿåˆ°é©•å‚²..."];
                    break;
                case 'ç¸é†«ç´°èŒå­¸':
                    messages = ["é¢å°å³å¼˜æ¯…è€å¸«çš„ç´°èŒå¤§è»ï¼Œä½ æ‹¿èµ·äº†é©è˜­æ°æŸ“è‰²çš„é‡£ç«¿...", "ä½ å¿µè‘—é‚£äº›æ‹—å£çš„èŒåï¼Œã€è‘¡è„çƒèŒã€ã€ã€éˆçƒèŒã€...æ„Ÿè¦ºè‡ªå·±åƒåœ¨å¿µä»€éº¼ç¥ç§˜çš„å’’èªã€‚", "ä½ æƒ³åƒè‡ªå·±æ˜¯å€‹è‹±å‹‡çš„æŠ—ç”Ÿç´ ï¼Œæ­£åœ¨å± æ®ºä¸€ç¾¤è¬æƒ¡çš„ç—…åŸé«”..."];
                    changes.kp[subject] = 32;
                    break;
                case 'ç´°èƒç”Ÿç‰©å­¸':
                    messages = ["ä½ æ‰“é–‹é¾æ›œå‰è€å¸«çš„é è·èª²ç¨‹å½±ç‰‡ï¼Œè©¦åœ–å¾ä¸­æ‰¾å‡ºç²’ç·šé«”æ˜¯ç´°èƒç™¼é›»å» ä¹‹å¤–çš„è€ƒé»...", "é«˜åŸºæ°é«”ã€å…§è³ªç¶²ã€æº¶é…¶é«”...ä½ æ„Ÿè¦ºè‡ªå·±çš„è…¦ç´°èƒæ­£åœ¨ç‚ºäº†ç†è§£ç´°èƒè€Œå¤§é‡å‡‹äº¡ã€‚", "ä½ æŠŠå½±ç‰‡èª¿åˆ°2å€é€Ÿæ’­æ”¾ï¼Œè€å¸«çš„è²éŸ³è®Šå¾—åƒèŠ±æ —é¼ ä¸€æ¨£..."];
                    break;
                case 'ä¿è‚²é†«å­¸æ¦‚è«–':
                    messages = ["ä½ ç¿»é–‹é™³è²å¿—è€å¸«çš„ä¿è‚²é†«å­¸è¬›ç¾©ï¼Œçœ‹åˆ°é‡ç”Ÿå‹•ç‰©æ•‘æ´çš„æ®µè½ï¼Œçªç„¶è¦ºå¾—ã€å­¸åºœè·¯é£›çŒ´ã€ä¹Ÿæ‡‰è©²è¢«å¥½å¥½ä¿è‚²ã€‚", "ã€æ£²åœ°ç ´ç¢åŒ–ã€...é€™äº›å·¨å¤§çš„åè©è®“ä½ æ„Ÿåˆ°æ²‰é‡ï¼Œä½†é¦–å…ˆï¼Œä½ å¾—å…ˆä¿è‚²å¥½ä½ è‡ªå·±çš„å­¸åˆ†ã€‚", "ä½ è®€åˆ°çŸ³è™çš„å›°å¢ƒï¼Œä¸ç¦æ‚²å¾ä¸­ä¾†ï¼Œä½†ä½ çœ‹äº†ä¸€çœ¼è‡ªå·±çš„æˆç¸¾ï¼Œç™¼ç¾è‡ªå·±çš„è™•å¢ƒæ¯”çŸ³è™é‚„è¦å±éšªã€‚"];
                    changes.stamina = -18;
                    break;
            }

            gameState.stamina += changes.stamina;
            gameState.kp[subject] += changes.kp[subject];
            
            showModal({
                title: `Kæ›¸ä¸­...`,
                text: random.choice(messages),
                stats: changes,
                choices: [{ text: 'ç­è§£äº†', style: 'bg-blue-500', action: triggerEndOfDaySequence }]
            });
        }

        function performWork() {
            const messages = ["ç‚ºäº†ä¸‹å€‹æœˆçš„è¦çš®å…é‹ï¼Œä½ å‡ºè³£äº†ä½ çš„éˆé­‚å’Œè‚è‡Ÿ...", "ä½ ç†Ÿç·´åœ°å°‡å»šé¤˜åˆ†é¡ï¼Œæ€è€ƒè‘—é€™äº›æ±è¥¿å¦‚æœæ‹¿å»åšå †è‚¥...", "ç«¯ç›¤å­æ™‚ï¼Œä½ å·®é»æ»‘å€’ï¼Œå±•ç¾äº†é€£é«”æ“é¸æ‰‹éƒ½é©šå˜†çš„æ ¸å¿ƒåŠ›é‡..."];
            const changes = { money: 400, stamina: -25 };
            gameState.money += changes.money;
            gameState.stamina += changes.stamina;
            showModal({
                title: 'æ‰“å·¥äººç”Ÿ',
                text: random.choice(messages),
                stats: changes,
                choices: [{ text: 'å”‰...', style: 'bg-blue-500', action: triggerEndOfDaySequence }]
            });
        }

        function performRest() {
             const messages = ["ä½ æœæ–·åœ°é¸æ“‡äº†ã€æˆ°ç•¥æ€§æ”¾æ£„ã€ï¼Œåƒä¸€å…·å¤§é«”è€å¸«ä¸€æ¨£èººåœ¨åºŠä¸Š...", "ä½ åœ¨å®¿èˆçš„åºŠä¸Šæ»¾ä¾†æ»šå»ï¼Œæœ€çµ‚æ»¾æˆäº†ä¸€é¡†å®Œç¾çš„å¢¨è¥¿å“¥é›è‚‰æ²...", "ä½ æ‰“é–‹æ‰‹æ©Ÿæƒ³æ”¾é¬†ä¸€ä¸‹ï¼Œçµæœæ¼”ç®—æ³•ç²¾æº–åœ°æ¨é€äº†ã€æœŸæœ«é«˜æ•ˆè¤‡ç¿’ã€çš„å½±ç‰‡..."];
            const changes = { stamina: 50 };
            gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + changes.stamina);
            showModal({
                title: 'å……é›»ä¸­...',
                text: random.choice(messages),
                stats: changes,
                choices: [{ text: 'çˆ½å•¦ï¼', style: 'bg-blue-500', action: triggerEndOfDaySequence }]
            });
        }
        
        function triggerEndOfDaySequence() {
            if (random.random() < 0.5) {
                handleRandomEvent();
            } else {
                finalizeDay();
            }
        }

        function finalizeDay() {
            gameState.isWaitingForEventChoice = false;
            gameState.money -= 100;
            gameState.day += 1;
            
            updateDisplay();
            checkGameOver();

            if (!gameState.isGameOver) {
                if (gameState.day > 14) {
                    endGame();
                } else {
                    processDay();
                }
            }
        }
        
        function handleRandomEvent(dayOffset = 0) {
            const availableEvents = [eventFlyingMonkey, eventHelmetTheft, eventTotoroTunnel, eventViciousDogs, eventColdShower];
            const chosenEvent = random.choice(availableEvents);
            chosenEvent(dayOffset);
        }

        const random = {
            choice: (arr) => arr[Math.floor(Math.random() * arr.length)],
            random: () => Math.random()
        };

        function eventFlyingMonkey(dayOffset) {
            const eventDay = gameState.day + dayOffset;
            gameState.history.push(`ç¬¬ ${eventDay} å¤©ï¼šåœ¨å­¸åºœè·¯ä¸Šé­é‡äº†ã€é£›çŒ´ã€ã€‚`);
            gameState.isWaitingForEventChoice = true;

            showModal({
                title: 'ã€çªç™¼äº‹ä»¶ã€‘å­¸åºœè·¯é£›çŒ´ï¼',
                text: 'ä¸­åˆï¼Œä½ é¨è»Šè¡Œç¶“å­¸åºœè·¯ï¼Œç›®æ“Šåˆ°äº†å‚³èªªä¸­çš„ç‰©ç¨®â€”â€”å­¸åºœè·¯é£›çŒ´ã€‚ä½ ç”šè‡³è€ƒæ…®è¦ä¸è¦ç‚ºæ­¤å¯«ä¸€ä»½å ±å‘Šï¼ŒæŠ•ç¨¿çµ¦é™³è²å¿—è€å¸«çš„ã€ä¿è‚²é†«å­¸æ¦‚è«–ã€...',
                choices: [
                    { text: 'ç”¨é«’è©±é€²è¡Œç‰©ç¨®äº¤æµ', style: 'bg-red-500', action: () => handleEventChoice('monkey-a') },
                    { text: 'ä¿æŒå®‰å…¨è·é›¢è§€å¯Ÿ', style: 'bg-gray-500', action: () => handleEventChoice('monkey-b') }
                ]
            });
        }

        function eventHelmetTheft(dayOffset) {
            const eventDay = gameState.day + dayOffset;
            gameState.history.push(`ç¬¬ ${eventDay} å¤©ï¼šå®‰å…¨å¸½è¢«å·äº†ã€‚`);
            gameState.isWaitingForEventChoice = true;
            showModal({
                title: 'ã€çªç™¼äº‹ä»¶ã€‘å®‰å…¨å¸½å¤±ç«Šæ¡ˆï¼',
                text: 'æ­£è¦å‡ºé–€ï¼Œå»ç™¼ç¾å®‰å…¨å¸½è¢«å“ªå€‹å¤©æ®ºçš„æ‘¸èµ°äº†ï¼åœè»Šå ´çš„ç›£è¦–å™¨ï¼Œå°±è·Ÿä½ çš„æ„›æƒ…ä¸€æ¨£ï¼Œåªæ˜¯å€‹è£é£¾å“ã€‚',
                choices: [
                    { text: 'å«æ·šæ–—å…§å®‰å…¨å¸½åº—', style: 'bg-gray-500', action: () => handleEventChoice('helmet-a') },
                    { text: 'ç¹¼æ‰¿å­¸é•·å§çš„æ„å¿—', style: 'bg-red-600', action: () => handleEventChoice('helmet-b') }
                ]
            });
        }
        
        function eventTotoroTunnel(dayOffset) {
            const eventDay = gameState.day + dayOffset;
            const changes = { stamina: -20, money: -150, kp: { 'ç¸é†«è§£å‰–å­¸(2)': -10 } };
            gameState.stamina += changes.stamina;
            gameState.money += changes.money;
            gameState.kp['ç¸é†«è§£å‰–å­¸(2)'] += changes.kp['ç¸é†«è§£å‰–å­¸(2)'];
            gameState.history.push(`ç¬¬ ${eventDay} å¤©ï¼šæ‰é€²äº†é¾è²“éš§é“çš„æ’æ°´æºã€‚`);
            
            showModal({
                title: 'ã€çªç™¼äº‹ä»¶ã€‘é¾è²“éš§é“å¥‡é‡è¨˜',
                text: 'ç‚ºäº†ç¯€çœ30ç§’ï¼Œä½ æ±ºå®šç©¿è¶Šå‚³èªªä¸­çš„æ·å¾‘ã€é¾è²“éš§é“ã€ï¼Œçµæœè…³ä¸€æ»‘ï¼Œèº«é«”å’Œæˆç¸¾å–®ä¸€èµ·æ‰é€²äº†æ’æ°´æºã€‚',
                stats: changes,
                choices: [{ text: 'å¤ªæ…˜äº†...', style: 'bg-blue-500', action: finalizeDay }]
            });
        }

        function eventViciousDogs(dayOffset) {
            const eventDay = gameState.day + dayOffset;
            gameState.history.push(`ç¬¬ ${eventDay} å¤©ï¼šè¢«æ ¡åœ’æƒ¡çŠ¬æ‰“åŠ«äº†å®µå¤œã€‚`);
            gameState.isWaitingForEventChoice = true;
            showModal({
                title: 'ã€çªç™¼äº‹ä»¶ã€‘èˆ‡æƒ¡çŠ¬çš„è·é›¢',
                text: 'æ™šä¸Šï¼Œä½ æ‹¿è‘—å‰›å¾é”äººå··è²·ä¾†çš„å®µå¤œï¼Œè¢«æ ¡åœ’çŠ¬ç•Œçš„ã€F4ã€åŒ…åœäº†ï¼Œç‰ å€‘çš„çœ¼ç¥ï¼Œæ¯”ä½ çš„æœªä¾†é‚„è¦é–ƒäº®ã€‚',
                choices: [
                    { text: 'ä¸Šç¹³ä¿è­·è²»(å®µå¤œ)', style: 'bg-gray-500', action: () => handleEventChoice('dogs-a') },
                    { text: 'è³­ä¸Šæ€§å‘½èˆ‡å®µå¤œè³½è·‘', style: 'bg-red-500', action: () => handleEventChoice('dogs-b') }
                ]
            });
        }

        function eventColdShower(dayOffset) {
            const eventDay = gameState.day + dayOffset;
            const changes = { stamina: -15 };
            gameState.stamina += changes.stamina;
            gameState.history.push(`ç¬¬ ${eventDay} å¤©ï¼šè¢«å®¿èˆçš„å†·æ°´æ¾¡èƒŒå›äº†ã€‚`);

            showModal({
                title: 'ã€çªç™¼äº‹ä»¶ã€‘ç†±æ°´æ¾¡çš„èƒŒå›',
                text: 'æ‹–è‘—ç–²æ†Šçš„èº«è»€å›åˆ°å®¿èˆï¼Œæƒ³æ´—å€‹ç†±æ°´æ¾¡ï¼Œçµæœæ°´é¾é ­åªæœ‰å†°å†·åˆºéª¨çš„æ°´ï¼ä½ æƒ³èµ·é€™å°±æ˜¯äººç”Ÿï¼Œç¸½æ˜¯äº‹èˆ‡é¡˜é•ã€‚',
                stats: changes,
                choices: [{ text: 'äººç”Ÿå¥½é›£...', style: 'bg-blue-500', action: finalizeDay }]
            });
        }
        
        function handleEventChoice(choice) {
             let changes = {}; let message = '';
             switch(choice) {
                case 'monkey-a': changes = { stamina: 10 }; message = 'é›–ç„¶ç‰ å¯èƒ½è½ä¸æ‡‚ï¼Œä½†ä½ æ„Ÿè¦ºå¥½å¤šäº†ã€‚'; break;
                case 'monkey-b': changes = { stamina: -25 }; message = 'ä½ ä¿æŒäº†å®‰å…¨è·é›¢ï¼Œä½†é‚£è¡æ“Šæ€§çš„ç•«é¢åœ¨ä½ è…¦ä¸­æ®ä¹‹ä¸å»ã€‚'; break;
                case 'helmet-a': changes = { money: -500, stamina: -20 }; message = 'ä½ ç”¨æ–°å°å¹£ä¸‹æ¶äº†é€™ä»¶å€’æ¥£äº‹ã€‚'; break;
                case 'helmet-b':
                    if (random.random() < 0.6) {
                        changes = { money: -2500, stamina: -30 };
                        message = 'ä½ å‰›ä¼¸æ‰‹ï¼Œä¸€å°Gogoroç„¡è²åœ°æ»‘åˆ°ä½ èº«å¾Œï¼Œä¸Šé¢åè‘—ä½ çš„ç³»ä¸»ä»»...';
                    } else { message = 'ä½ å®Œæˆäº†å±ç§‘å¤§çš„ç¥è–äº¤æ¥å„€å¼ï¼Œæˆ´ä¸Šäº†ä¸€é ‚å……æ»¿æ•…äº‹çš„å®‰å…¨å¸½ã€‚';}
                    break;
                case 'dogs-a': changes = { stamina: -15, money: -80 }; message = 'ä½ çœ‹è‘—å®µå¤œè¢«åˆ†é£Ÿï¼Œæ„Ÿå˜†ç”Ÿå‘½ä¸­çš„ä¸€åˆ‡çµ‚å°‡é€å»ã€‚'; break;
                case 'dogs-b':
                     if (random.random() < 0.5) {
                        changes = { stamina: -30 };
                        message = 'ä½ è·‘è´äº†ç‹—ï¼Œä½†è·‘ä¸è´å‘½é‹ï¼Œå®µå¤œé‚„æ˜¯åœ¨åŠè·¯è·Ÿä½ èªªå†è¦‹äº†ã€‚';
                    } else { message = 'ä½ ç™¼æ®äº†è…ä¸Šè…ºç´ çš„æ¥µé™ï¼ŒæˆåŠŸå¸¶è‘—å®µå¤œå›åˆ°çµ‚é»ï¼';}
                    break;
             }
             gameState.stamina += changes.stamina || 0;
             gameState.money += changes.money || 0;
             showModal({title: 'äº‹ä»¶çµæœ', text: message, stats: changes, choices: [{text: 'ç¹¼çºŒ...', style:'bg-blue-500', action: finalizeDay}] });
        }
        
        function checkGameOver() {
             if (gameState.stamina <= 0 || gameState.money < 0) {
                gameState.isGameOver = true;
                const reason = gameState.stamina <= 0 ? "ä½ çˆ†è‚éåº¦ï¼Œçœ¼å‰ä¸€é»‘..." : "ä½ çª®åˆ°é€£è²·ç­†çš„éŒ¢éƒ½æ²’äº†...";
                showFinalScreen(false, reason);
            }
        }

        function endGame() {
            if (gameState.isGameOver) return;
            gameState.isGameOver = true;
            
            let passedCount = 0;
            for(const subject in gameState.grades) {
                const finalGrade = Math.min(100, gameState.grades[subject] + Math.floor(gameState.kp[subject] / 1.0));
                if (finalGrade >= 60) passedCount++;
            }
            const isVictory = passedCount === Object.keys(gameState.grades).length;
            showFinalScreen(isVictory, "å¯©åˆ¤çš„æ™‚åˆ»ä¾†è‡¨...");
        }

        function showFinalScreen(isVictory, message) {
            if (isVictory) {
                showCelebrationModal();
                return; 
            }
            
            let resultsHTML = '';
            for(const subject in gameState.grades) {
                const finalGrade = Math.min(100, gameState.grades[subject] + Math.floor(gameState.kp[subject] / 1.0));
                resultsHTML += `<div class="flex justify-between p-2 rounded ${finalGrade >= 60 ? 'bg-emerald-200 text-emerald-800' : 'bg-red-200 text-red-800'}"><span>${subject}</span><span class="font-bold">${finalGrade}åˆ† [${finalGrade >= 60 ? 'PASS' : 'FAIL'}]</span></div>`;
            }

            let historyHTML = '';
            if (gameState.history.length > 0) {
                historyHTML = `<div class="text-left mt-4 border-t pt-2"><h4 class="font-bold text-gray-700">å¤§äº‹ç´€</h4><div class="text-xs text-gray-500">${gameState.history.map(h => `<p>- ${h}</p>`).join('')}</div></div>`;
            }
            
            const title = message === "å¯©åˆ¤çš„æ™‚åˆ»ä¾†è‡¨..." ? 'æˆç¸¾å–®' : 'æ™æ‰å¤±æ•—...';
            const failText = (message === "å¯©åˆ¤çš„æ™‚åˆ»ä¾†è‡¨..." ? 'å¯æƒœ...ä½ çš„è‚ä¼¼ä¹é‚„æœ‰é€²æ­¥ç©ºé–“ã€‚' : message)
            
            showModal({
                title: title,
                text: `${failText}<div class="mt-4 space-y-1">${resultsHTML}</div>${historyHTML}`,
                choices: [
                    {text: 'é‡æ–°é–‹å§‹', style: 'bg-indigo-500', action: restartGame}
                ]
            });
        }

        function restartGame() {
            const modalEl = document.querySelector('.modal-overlay');
            if (modalEl) {
                modalEl.classList.add('closing');
                setTimeout(() => modalEl.remove(), 300);
            }
            
            initializeGameState();
            updateDisplay();
            actionPanel.innerHTML = '';
            showModal({
                title: "æ­¡è¿å›ä¾†...",
                text: "ã€ç¸é†«å¤§å­¸ç‰²å†æ¬¡çš„æ™æ‰ã€‘ï¼é€™æ¬¡ï¼Œä½ æ˜¯å¦èƒ½æ”¹å¯«å‘½é‹ï¼Ÿ",
                choices: [{ text: 'é–‹å§‹æ™æ‰', style: 'bg-red-500', action: processDay }]
            });
        }

        function showCelebrationModal() {
            const celebrationOverlay = document.createElement('div');
            celebrationOverlay.className = 'modal-overlay';
            celebrationOverlay.innerHTML = `
                <div class="modal-content tada-animation w-11/12 max-w-md p-8 rounded-2xl text-center space-y-4 !bg-white">
                    <div class="text-6xl">ğŸ‰</div>
                    <h2 class="text-3xl font-bold text-amber-500">All Passï¼</h2>
                    <p class="text-lg text-gray-800">æ­å–œï¼ä½ æˆåŠŸåœ¨æœ€å¾Œä¸€åˆ»æŠŠå­¸åˆ†å¾æ‡¸å´–é‚Šæ‹‰äº†å›ä¾†ï¼ä½ çš„è‚æŒ‡æ•¸å¯èƒ½æ›ä¾†äº† GPAï¼</p>
                    <p class="text-base text-gray-500">ä½ å¯ä»¥å®‰å¿ƒæ”¾å‡äº†ï¼Œç›´åˆ°ä½ çœ‹åˆ°ä¸‹å­¸æœŸçš„æ›¸å–®ï¼Œç„¶å¾Œå†æ¬¡é–‹å§‹æ‡·ç–‘äººç”Ÿ...</p>
                    <div class="flex gap-4">
                        <button id="restart-btn" class="flex-1 mt-4 px-6 py-2 bg-indigo-500 text-white font-bold rounded-lg hover:bg-indigo-600">å†ç©ä¸€æ¬¡</button>
                    </div>
                </div>
            `;
            document.body.appendChild(celebrationOverlay);
            celebrationOverlay.querySelector('#restart-btn').addEventListener('click', () => {
                document.body.removeChild(celebrationOverlay);
                restartGame();
            });
        }
        
        // ==================================
        // 7. äº‹ä»¶ç›£è½
        // ==================================
        actionPanel.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                handleAction(e.target.dataset.action);
            }
        });

        // ==================================
        // 8. éŠæˆ²å•Ÿå‹•
        // ==================================
        window.onload = () => {
            initializeGameState();
            updateDisplay();
            showModal({
                title: "æ­¡è¿ä¾†åˆ°...",
                text: "ã€ç¸é†«å¤§å­¸ç‰²æœ€å¾Œçš„æ™æ‰ã€‘ï¼å­¸æœŸæœ«åªå‰©14å¤©ï¼Œä½ çš„æˆç¸¾å²Œå²Œå¯å±ã€‚ç™¼æ®ä½ åƒ…å­˜çš„æ±‚ç”Ÿæœ¬èƒ½ï¼Œæ´»ä¸‹å»ï¼",
                choices: [{ text: 'é–‹å§‹æ™æ‰', style: 'bg-red-500', action: processDay }]
            });
        };

    </script>
</body>
</html>
